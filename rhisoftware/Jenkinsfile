pipeline {
    agent any

    tools {
        // S'assure que Maven est dispo sur le syst√®me Jenkins
        maven 'Maven 3.8.1'
    }

    environment {
        DB_URL = 'jdbc:postgresql://192.168.0.102:5433/employe_db'
        DB_USERNAME = 'springuser'
        DB_PASSWORD = 'springpass'
    }

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/Mrabett/spring-liquibase-jenkins.git'
            }
        }

        stage('Run Liquibase') {
            steps {
                sh '''
                    cd rhisoftware
                    liquibase --changeLogFile=src/main/resources/db/changelog/db.changelog-master.yaml \
                              --url=$DB_URL \
                              --username=$DB_USERNAME \
                              --password=$DB_PASSWORD \
                              update
                '''
            }
        }

        stage('Build & Run App') {
            steps {
                sh 'cd rhisoftware && ./mvnw clean install'
                sh 'cd rhisoftware && ./mvnw spring-boot:run'
            }
        }
    }
}
